<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>AI-Solutions Admin Dashboard</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      /* Additional styles that complement the existing styles.css */
      .main-nav {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .nav-link {
        text-decoration: none;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nav-link i {
        font-size: 0.9rem;
      }

      .nav-link.active {
        background-color: #0066cc;
        color: white;
      }

      .nav-link:hover:not(.active) {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .notification-bell {
        position: relative;
        margin-left: 15px;
        cursor: pointer;
      }

      .notification-bell i {
        font-size: 1.2rem;
        color: white;
      }

      .notification-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: #cc0000;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
      }

      .section {
        display: none;
        background-color: lightblue;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      .section.active {
        display: block;
      }

      .search-container {
        display: flex;
        margin-bottom: 15px;
        align-items: center;
        gap: 10px;
      }

      .search-container input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px 0 0 6px;
        font-size: 0.95rem;
      }

      .search-container button {
        padding: 10px 15px;
        background-color: #0066cc;
        color: white;
        border: none;
        border-radius: 0 6px 6px 0;
        cursor: pointer;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .filter-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .filter-btn {
        padding: 8px 15px;
        background-color: #0066cc;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
      }

      .filter-btn.active {
        background-color: #0066cc;
        color: white;
        border-color: #0066cc;
      }

      .unread-inquiry {
        background-color: lightgrey;
        font-weight: 500;
      }

      .image-preview {
        max-width: 100px;
        max-height: 60px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-content {
        background: white;
        padding: 25px;
        max-width: 800px;
        width: 90%;
        border-radius: 10px;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
      }

      .close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
      }

      .modal-image {
        max-width: 100%;
        max-height: 400px;
        margin: 15px 0;
        display: block;
        border-radius: 8px;
      }

      .edit-form {
        display: grid;
        gap: 15px;
      }

      .edit-form input,
      .edit-form textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }

      .edit-form textarea {
        min-height: 150px;
      }

      /* Toast notification styles */
      .toast {
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
        animation: slideIn 0.3s ease-out;
        max-width: 350px;
      }

      .toast.success {
        border-left: 4px solid #28a745;
      }

      .toast.error {
        border-left: 4px solid #dc3545;
      }

      .toast.warning {
        border-left: 4px solid #ffc107;
      }

      .toast-message {
        flex: 1;
        margin-right: 15px;
      }

      .toast-close {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        font-size: 1rem;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }

      /* Feedback specific styles */
      .feedback-stats {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .stat-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        flex: 1;
        min-width: 200px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0;
      }

      .rating-stars {
        color: gold;
      }

      .feedback-list-container {
        overflow-x: auto;
      }

      .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }

      .badge.new {
        background-color: #0066cc;
        color: white;
      }

      .badge.responded {
        background-color: #28a745;
        color: white;
      }

      /* Response form styles */
      .response-form {
        padding: 15px 0;
      }

      .response-form .form-group {
        margin-bottom: 15px;
      }

      .response-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .response-form textarea {
        width: 100%;
        min-height: 150px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .response-form input[type="email"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .form-actions button {
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .form-actions button.secondary {
        background: #f0f0f0;
        color: #333;
      }
      .btn-loading {
        position: relative;
      }
      .btn-loading .fa-spinner {
        margin-right: 8px;
      }
      .btn-loading:disabled {
        opacity: 0.8;
        cursor: not-allowed;
      }

      /* Enhanced toast notifications */
      .toast {
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
        animation: slideIn 0.3s ease-out;
        max-width: 350px;
        transition: all 0.3s ease;
      }

      .toast.success {
        border-left: 4px solid #28a745;
      }

      .toast.error {
        border-left: 4px solid #dc3545;
      }

      .toast.warning {
        border-left: 4px solid #ffc107;
      }

      .toast-icon {
        margin-right: 15px;
        font-size: 1.2rem;
      }

      .toast-message {
        flex: 1;
        margin-right: 15px;
      }

      .toast-close {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        font-size: 1rem;
      }

      .fade-out {
        opacity: 0;
        transform: translateX(100%);
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        header {
          flex-direction: column;
          gap: 15px;
          padding: 15px;
        }

        .main-nav {
          width: 100%;
          flex-wrap: wrap;
          justify-content: center;
        }

        .search-container {
          flex-direction: column;
        }

        .search-container input {
          border-radius: 6px;
          width: 100%;
        }

        .search-container button {
          border-radius: 6px;
          width: 100%;
        }

        .filter-controls {
          flex-wrap: wrap;
        }

        .filter-btn {
          flex: 1;
          min-width: calc(33% - 10px);
        }

        .feedback-stats {
          flex-direction: column;
        }

        .stat-card {
          min-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo-container">
        <img src="/images/AI-SOLUTIONS LOGO.png" alt="AI-Solutions Logo" />
        <h1>Admin Dashboard</h1>
      </div>
      <nav class="main-nav">
        <a href="#" class="nav-link active" data-tab="inquiries">
          <i class="fas fa-envelope"></i> Inquiries
        </a>
        <a href="#" class="nav-link" data-tab="articles">
          <i class="fas fa-newspaper"></i> Articles
        </a>
        <a href="#" class="nav-link" data-tab="events">
          <i class="fas fa-calendar-alt"></i> Events
        </a>
        <a href="#" class="nav-link" data-tab="feedback">
          <i class="fas fa-comment-alt"></i> Feedback
        </a>
        <a href="#" class="nav-link" data-tab="analytics">
          <i class="fas fa-chart-line"></i> Analytics
        </a>
        <div class="notification-bell" onclick="showUnreadInquiries()">
          <i class="fas fa-bell"></i>
          <span class="notification-count" id="notificationCount">0</span>
        </div>
      </nav>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </header>

    <main class="dashboard">
      <div class="section active" id="inquiries">
        <h2><i class="fas fa-envelope"></i> Customer Inquiries</h2>
        <div class="search-container">
          <input
            type="text"
            id="inquirySearch"
            placeholder="Search by name, email, company or job title"
            oninput="filterTable('inquiryTable', 'inquirySearch')"
          />
          <button onclick="filterTable('inquiryTable', 'inquirySearch')">
            <i class="fas fa-search"></i> Search
          </button>
        </div>
        <div class="action-buttons">
          <button onclick="exportToCSV()">
            <i class="fas fa-file-export"></i> Export to CSV
          </button>
          <button onclick="markAllAsRead()">
            <i class="fas fa-check-double"></i> Mark All as Read
          </button>
        </div>
        <div class="filter-controls">
          <button
            class="filter-btn active"
            data-filter="all"
            onclick="filterInquiries('all')"
          >
            All
          </button>
          <button
            class="filter-btn"
            data-filter="unread"
            onclick="filterInquiries('unread')"
          >
            Unread
          </button>
          <button
            class="filter-btn"
            data-filter="read"
            onclick="filterInquiries('read')"
          >
            Read
          </button>
        </div>
        <div style="overflow-x: auto">
          <table id="inquiryTable">
            <thead>
              <tr>
                <th>Status</th>
                <th>Name</th>
                <th>Email</th>
                <th>Company</th>
                <th>Job Title</th>
                <th>Message</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="inquiryBody"></tbody>
          </table>
        </div>
      </div>

      <div class="section" id="articles">
        <h2><i class="fas fa-newspaper"></i> Manage Articles</h2>
        <div class="search-container">
          <input
            type="text"
            id="articlesSearchInput"
            placeholder="Search articles..."
            oninput="filterTable('articlesTable', 'articlesSearchInput')"
          />
          <button onclick="filterTable('articlesTable', 'articlesSearchInput')">
            <i class="fas fa-search"></i> Search
          </button>
        </div>
        <div class="article-form">
          <h3><i class="fas fa-plus-circle"></i> Add New Article</h3>
          <div class="form-group">
            <input
              type="text"
              id="articleTitle"
              placeholder="Article Title"
              required
            />
          </div>
          <div class="form-group">
            <textarea
              id="articleContent"
              placeholder="Article Content"
              required
            ></textarea>
          </div>
          <div class="form-group">
            <input type="file" id="articleImageFile" accept="image/*" />
          </div>
          <button onclick="addArticle()">
            <i class="fas fa-save"></i> Add Article
          </button>
        </div>
        <div style="overflow-x: auto">
          <table id="articlesTable">
            <thead>
              <tr>
                <th>Title</th>
                <th>Image</th>
                <th>Content Preview</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="articlesBody"></tbody>
          </table>
        </div>
      </div>

      <div class="section" id="events">
        <h2><i class="fas fa-calendar-alt"></i> Manage Events</h2>
        <div class="search-container">
          <input
            type="text"
            id="eventsSearchInput"
            placeholder="Search events..."
            oninput="filterTable('eventsTable', 'eventsSearchInput')"
          />
          <button onclick="filterTable('eventsTable', 'eventsSearchInput')">
            <i class="fas fa-search"></i> Search
          </button>
        </div>
        <div class="event-form">
          <h3><i class="fas fa-plus-circle"></i> Add New Event</h3>
          <div class="form-group">
            <input
              type="text"
              id="eventTitle"
              placeholder="Event Title"
              required
            />
          </div>
          <div class="form-group">
            <textarea
              id="eventDescription"
              placeholder="Event Description"
              required
            ></textarea>
          </div>
          <div class="form-group">
            <input type="datetime-local" id="eventDateTime" required />
          </div>
          <div class="form-group">
            <input type="file" id="eventImageFile" accept="image/*" />
          </div>
          <button onclick="addEvent()">
            <i class="fas fa-save"></i> Add Event
          </button>
        </div>
        <div style="overflow-x: auto">
          <table id="eventsTable">
            <thead>
              <tr>
                <th>Title</th>
                <th>Image</th>
                <th>Description</th>
                <th>Date & Time</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="eventsBody"></tbody>
          </table>
        </div>
      </div>

      <div class="section" id="feedback">
        <h2><i class="fas fa-comment-alt"></i> Customer Feedback</h2>

        <div class="feedback-controls">
          <div class="search-container">
            <input
              type="text"
              id="feedbackSearch"
              placeholder="Search feedback..."
              oninput="filterFeedback()"
            />
            <button onclick="filterFeedback()">
              <i class="fas fa-search"></i> Search
            </button>
          </div>

          <div class="feedback-filters">
            <button
              class="filter-btn active"
              data-filter="all"
              onclick="filterFeedback('all')"
            >
              All Feedback
            </button>
            <button
              class="filter-btn"
              data-filter="5"
              onclick="filterFeedback('5')"
            >
              5 Stars
            </button>
            <button
              class="filter-btn"
              data-filter="4"
              onclick="filterFeedback('4')"
            >
              4 Stars
            </button>
            <button
              class="filter-btn"
              data-filter="3"
              onclick="filterFeedback('3')"
            >
              3 Stars
            </button>
            <button
              class="filter-btn"
              data-filter="1-2"
              onclick="filterFeedback('1-2')"
            >
              1-2 Stars
            </button>
            <button
              class="filter-btn"
              data-filter="new"
              onclick="filterFeedback('new')"
            >
              New
            </button>
            <button
              class="filter-btn"
              data-filter="responded"
              onclick="filterFeedback('responded')"
            >
              Responded
            </button>
          </div>
        </div>

        <div class="feedback-stats">
          <div class="stat-card">
            <h3>Average Rating</h3>
            <div class="stat-value" id="avgRating">4.2</div>
            <div class="rating-stars">
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star-half-alt"></i>
            </div>
          </div>
          <div class="stat-card">
            <h3>Total Feedback</h3>
            <div class="stat-value" id="totalFeedback">124</div>
          </div>
          <div class="stat-card">
            <h3>New This Month</h3>
            <div class="stat-value" id="newFeedback">24</div>
          </div>
        </div>

        <div class="feedback-list-container">
          <table id="feedbackTable">
            <thead>
              <tr>
                <th>User</th>
                <th>Rating</th>
                <th>Feedback</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="feedbackBody">
              <!-- Feedback items will be loaded here from Firebase -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="section" id="analytics">
        <h2><i class="fas fa-chart-line"></i> Analytics Dashboard</h2>
        <div class="time-period-selector">
          <select id="timePeriod" onchange="loadAnalytics()">
            <option value="7">Last 7 Days</option>
            <option value="30" selected>Last 30 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="365">Last Year</option>
          </select>
        </div>
        <div class="analytics-summary">
          <div class="summary-card">
            <h3>Total Visitors</h3>
            <div class="summary-value" id="totalVisitors">0</div>
            <div class="summary-change" id="visitorsChange">0%</div>
          </div>
          <div class="summary-card">
            <h3>Page Views</h3>
            <div class="summary-value" id="totalPageViews">0</div>
            <div class="summary-change" id="pageViewsChange">0%</div>
          </div>
          <div class="summary-card">
            <h3>Avg. Session</h3>
            <div class="summary-value" id="avgSessionDuration">0m 0s</div>
            <div class="summary-change" id="sessionDurationChange">0%</div>
          </div>
          <div class="summary-card">
            <h3>Bounce Rate</h3>
            <div class="summary-value" id="bounceRate">0%</div>
            <div class="summary-change" id="bounceRateChange">0%</div>
          </div>
        </div>
        <div class="analytics-container">
          <div class="analytics-card wide">
            <h3>Site Visitors</h3>
            <canvas id="visitorsChart"></canvas>
          </div>
          <div class="analytics-card">
            <h3>Traffic Sources</h3>
            <canvas id="trafficSourcesChart"></canvas>
          </div>
          <div class="analytics-card">
            <h3>Popular Content</h3>
            <canvas id="contentChart"></canvas>
          </div>
          <div class="analytics-card wide">
            <h3>User Engagement</h3>
            <canvas id="engagementChart"></canvas>
          </div>
        </div>
      </div>
    </main>

    <!-- Toast notification container -->
    <div
      id="toastContainer"
      style="position: fixed; bottom: 20px; right: 20px; z-index: 1000"
    ></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAtjeL9bPG4jb3mIhjvBiJJoR1PhJgtx0I",
        authDomain: "ai-solutions-981f1.firebaseapp.com",
        databaseURL: "https://ai-solutions-981f1-default-rtdb.firebaseio.com",
        projectId: "ai-solutions-981f1",
        storageBucket: "ai-solutions-981f1.appspot.com",
        messagingSenderId: "501089774980",
        appId: "1:501089774980:web:0bfef808f9ba6ec04641d1",
        measurementId: "G-K8C7956N0B",
      };

      firebase.initializeApp(firebaseConfig);
      const storage = firebase.storage();

      let unreadInquiriesCount = 0;
      let currentFilter = "all";
      let currentFeedbackFilter = "all";
      let feedbackData = [];

      // ======================
      // REUSABLE IMAGE UPLOAD FUNCTION
      // ======================
      function uploadImage(file, folder) {
        return new Promise((resolve, reject) => {
          if (!file) {
            reject(new Error("No file selected"));
            return;
          }

          const validTypes = [
            "image/jpeg",
            "image/png",
            "image/webp",
            "image/gif",
          ];
          if (!validTypes.includes(file.type)) {
            reject(new Error("Only JPG, PNG, WEBP or GIF images are allowed"));
            return;
          }

          const maxSizeMB = 5;
          if (file.size > maxSizeMB * 1024 * 1024) {
            reject(new Error(`Image must be smaller than ${maxSizeMB}MB`));
            return;
          }

          const sanitizedFilename = file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
          const storageRef = storage.ref(
            `${folder}/${Date.now()}_${sanitizedFilename}`
          );

          const metadata = {
            contentType: file.type,
            customMetadata: {
              uploadedBy: firebase.auth().currentUser?.email || "unknown",
              originalFilename: file.name,
            },
          };

          const uploadTask = storageRef.put(file, metadata);

          uploadTask.on(
            "state_changed",
            (snapshot) => {
              const progress =
                (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              console.log(`Upload is ${progress}% done`);
            },
            (error) => {
              console.error("Upload error:", error);
              reject(new Error(`Upload failed: ${error.message}`));
            },
            () => {
              uploadTask.snapshot.ref
                .getDownloadURL()
                .then((downloadURL) => resolve(downloadURL))
                .catch((error) =>
                  reject(
                    new Error(`Failed to get download URL: ${error.message}`)
                  )
                );
            }
          );
        });
      }

      function logout() {
        firebase
          .auth()
          .signOut()
          .then(() => {
            window.location.href = "index.html";
          });
      }

      function setupTabSwitching() {
        const navLinks = document.querySelectorAll(".nav-link");
        navLinks.forEach((link) => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            navLinks.forEach((l) => l.classList.remove("active"));
            document.querySelectorAll(".section").forEach((section) => {
              section.classList.remove("active");
            });
            this.classList.add("active");
            const tabId = this.getAttribute("data-tab");
            document.getElementById(tabId).classList.add("active");
            if (tabId === "articles") loadArticles();
            if (tabId === "events") loadEvents();
            if (tabId === "feedback") loadFeedback();
            if (tabId === "analytics") loadAnalytics();
          });
        });
      }

      function filterTable(tableId, searchInputId) {
        const input = document
          .getElementById(searchInputId)
          .value.toLowerCase();
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        rows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(input) ? "" : "none";
        });
      }

      function exportToCSV() {
        let csv = "Status,Name,Email,Company,Job Title,Message,Date\n";
        document.querySelectorAll("#inquiryTable tbody tr").forEach((row) => {
          if (row.style.display !== "none") {
            const cols = row.querySelectorAll("td");
            const rowData = [...cols]
              .slice(0, -1)
              .map((td) => `"${td.innerText}"`)
              .join(",");
            csv += rowData + "\n";
          }
        });
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `inquiries_${
          new Date().toISOString().split("T")[0]
        }.csv`;
        link.click();
      }

      function markAllAsRead() {
        if (
          confirm("Are you sure you want to mark all unread inquiries as read?")
        ) {
          firebase
            .database()
            .ref("inquiries")
            .once("value", (snapshot) => {
              const updates = {};
              snapshot.forEach((child) => {
                if (!child.val().read) {
                  updates[`${child.key}/read`] = true;
                }
              });
              firebase
                .database()
                .ref("inquiries")
                .update(updates)
                .then(() => {
                  showToast("All inquiries marked as read", "success");
                  updateNotificationCount();
                  loadInquiries();
                })
                .catch((error) => {
                  showToast(
                    "Failed to mark all as read: " + error.message,
                    "error"
                  );
                });
            });
        }
      }

      function filterInquiries(filterType) {
        currentFilter = filterType;
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document
          .querySelector(`.filter-btn[data-filter="${filterType}"]`)
          .classList.add("active");
        const rows = document.querySelectorAll("#inquiryTable tbody tr");
        rows.forEach((row) => {
          if (filterType === "all") {
            row.style.display = "";
          } else if (filterType === "read") {
            const isRead = !row.classList.contains("unread-inquiry");
            row.style.display = isRead ? "" : "none";
          } else if (filterType === "unread") {
            const isUnread = row.classList.contains("unread-inquiry");
            row.style.display = isUnread ? "" : "none";
          }
        });
      }

      function markAsRead(inquiryId) {
        firebase
          .database()
          .ref(`inquiries/${inquiryId}`)
          .update({ read: true })
          .then(() => {
            showToast("Inquiry marked as read", "success");
            updateNotificationCount();
            loadInquiries();
          })
          .catch((error) => {
            showToast("Failed to mark as read: " + error.message, "error");
          });
      }

      function updateNotificationCount() {
        firebase
          .database()
          .ref("inquiries")
          .once("value", (snapshot) => {
            let count = 0;
            snapshot.forEach((child) => {
              if (!child.val().read) count++;
            });
            unreadInquiriesCount = count;
            document.getElementById("notificationCount").textContent = count;
          });
      }

      function showUnreadInquiries() {
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.remove("active");
        });
        document
          .querySelector('.nav-link[data-tab="inquiries"]')
          .classList.add("active");
        document.querySelectorAll(".section").forEach((section) => {
          section.classList.remove("active");
        });
        document.getElementById("inquiries").classList.add("active");
        filterInquiries("unread");
      }

      function loadInquiries() {
        const tableBody = document.getElementById("inquiryBody");
        firebase
          .database()
          .ref("inquiries")
          .on("value", (snapshot) => {
            tableBody.innerHTML = "";
            if (snapshot.exists()) {
              snapshot.forEach((child) => {
                const data = child.val();
                const row = document.createElement("tr");
                if (!data.read) row.classList.add("unread-inquiry");
                const timestamp = data.timestamp || Date.now();
                const date = new Date(timestamp);
                const formattedDate =
                  date.toLocaleDateString() + " " + date.toLocaleTimeString();
                row.innerHTML = `
                  <td>${
                    data.read
                      ? '<span class="badge read">Read</span>'
                      : '<span class="badge unread">Unread</span>'
                  }</td>
                  <td>${data.name}</td>
                  <td><a href="mailto:${data.email}">${data.email}</a></td>
                  <td>${data.company || "-"}</td>
                  <td>${data.job || "-"}</td>
                  <td>${data.message.substring(0, 50)}${
                  data.message.length > 50 ? "..." : ""
                }</td>
                  <td>${formattedDate}</td>
                  <td>
                    ${
                      !data.read
                        ? `<button onclick="markAsRead('${child.key}')"><i class="fas fa-check"></i> Mark Read</button>`
                        : ""
                    }
                    <button class="danger" onclick="deleteInquiry('${
                      child.key
                    }')"><i class="fas fa-trash"></i></button>
                  </td>
                `;
                row.addEventListener("click", function (e) {
                  if (
                    e.target.tagName !== "BUTTON" &&
                    e.target.tagName !== "I"
                  ) {
                    showInquiryModal(child.key, data);
                  }
                });
                tableBody.appendChild(row);
              });
              filterInquiries(currentFilter);
            } else {
              tableBody.innerHTML = `
                <tr><td colspan="8" style="text-align: center;">No inquiry data available.</td></tr>
              `;
            }
            updateNotificationCount();
          });
      }

      function showInquiryModal(inquiryId, data) {
        const timestamp = data.timestamp || Date.now();
        const date = new Date(timestamp);
        const formattedDate =
          date.toLocaleDateString() + " " + date.toLocaleTimeString();

        const modalHTML = `
          <div class="modal" id="inquiryModal">
            <div class="modal-content">
              <span class="close-btn" onclick="document.getElementById('inquiryModal').remove()">×</span>
              <h2>Inquiry Details</h2>
              <div class="inquiry-details">
                <p><strong>Name:</strong> ${data.name}</p>
                <p><strong>Email:</strong> <a href="mailto:${data.email}">${
          data.email
        }</a></p>
                <p><strong>Company:</strong> ${data.company || "-"}</p>
                <p><strong>Job Title:</strong> ${data.job || "-"}</p>
                <p><strong>Date:</strong> ${formattedDate}</p>
                <div class="message-container">
                  <h3>Message:</h3>
                  <p>${data.message}</p>
                </div>
              </div>
              <div class="modal-actions">
                <button onclick="markAsRead('${inquiryId}')"><i class="fas fa-check"></i> Mark as Read</button>
                <button class="danger" onclick="deleteInquiry('${inquiryId}')"><i class="fas fa-trash"></i> Delete</button>
                <button onclick="document.getElementById('inquiryModal').remove()"><i class="fas fa-times"></i> Close</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML("beforeend", modalHTML);
        document.getElementById("inquiryModal").style.display = "flex";

        if (!data.read) {
          markAsRead(inquiryId);
        }
      }

      function deleteInquiry(inquiryId) {
        if (confirm("Are you sure you want to delete this inquiry?")) {
          firebase
            .database()
            .ref("inquiries/" + inquiryId)
            .remove()
            .then(() => {
              showToast("Inquiry deleted successfully", "success");
              updateNotificationCount();
            })
            .catch((error) => {
              showToast("Failed to delete inquiry: " + error.message, "error");
            });
        }
      }

      function loadArticles() {
        const articlesBody = document.getElementById("articlesBody");
        firebase
          .database()
          .ref("articles")
          .on("value", (snapshot) => {
            articlesBody.innerHTML = "";
            if (snapshot.exists()) {
              snapshot.forEach((child) => {
                const article = child.val();
                const date = new Date(article.timestamp);
                const formattedDate = date.toLocaleDateString();
                const articleRow = document.createElement("tr");
                articleRow.innerHTML = `
                  <td>${article.title}</td>
                  <td>
                    ${
                      article.imageUrl
                        ? `<img src="${article.imageUrl}" class="image-preview" onclick="showImageModal('${article.imageUrl}')" />`
                        : "No Image"
                    }
                  </td>
                  <td>${article.content.substring(0, 100)}${
                  article.content.length > 100 ? "..." : ""
                }</td>
                  <td>${formattedDate}</td>
                  <td>
                    <button onclick="editArticle('${
                      child.key
                    }')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="danger" onclick="deleteArticle('${
                      child.key
                    }')"><i class="fas fa-trash"></i></button>
                    <button onclick="viewArticle('${
                      child.key
                    }')"><i class="fas fa-eye"></i></button>
                  </td>
                `;
                articlesBody.appendChild(articleRow);
              });
            } else {
              articlesBody.innerHTML = `
                <tr><td colspan="5" style="text-align: center;">No article data available.</td></tr>
              `;
            }
          });
      }

      // IMPROVED ARTICLE FUNCTIONS
      // ======================
      function addArticle() {
        const user = firebase.auth().currentUser;
        if (!user || user.email !== "admin@ai-solutions.com") {
          showToast("Unauthorized. Please log in as admin.", "error");
          return;
        }

        const title = document.getElementById("articleTitle").value.trim();
        const content = document.getElementById("articleContent").value.trim();
        const imageFile = document.getElementById("articleImageFile").files[0];

        if (!title || !content) {
          showToast("Title and content are required.", "error");
          return;
        }

        const submitBtn = document.querySelector(
          "#articles button[onclick='addArticle()']"
        );
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Uploading...';

        if (imageFile) {
          uploadImage(imageFile, "articles")
            .then((downloadURL) => {
              saveArticle(title, content, downloadURL);
              showToast(
                "Article published successfully with image!",
                "success"
              );
            })
            .catch((error) => {
              console.error(
                "Image upload failed, saving without image:",
                error
              );
              saveArticle(title, content, "");
              showToast(
                `Article published without image (${error.message})`,
                "warning"
              );
            })
            .finally(() => {
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i class="fas fa-save"></i> Add Article';
            });
        } else {
          saveArticle(title, content, "");
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-save"></i> Add Article';
          showToast("Article published successfully (no image)", "success");
        }
      }

      function saveArticle(title, content, imageUrl) {
        const newArticleRef = firebase.database().ref("articles").push();
        const articleData = {
          title,
          content,
          imageUrl,
          timestamp: Date.now(),
          lastUpdated: Date.now(),
          author: firebase.auth().currentUser.email,
        };

        newArticleRef
          .set(articleData)
          .then(() => {
            document.getElementById("articleTitle").value = "";
            document.getElementById("articleContent").value = "";
            document.getElementById("articleImageFile").value = "";
          })
          .catch((error) => {
            console.error("Error saving article:", error);
            showToast("Failed to save article: " + error.message, "error");
          });
      }

      function editArticle(articleId) {
        firebase
          .database()
          .ref("articles/" + articleId)
          .once("value")
          .then((snapshot) => {
            const article = snapshot.val();
            const modalHTML = `
              <div class="modal" id="editArticleModal">
                <div class="modal-content">
                  <span class="close-btn" onclick="document.getElementById('editArticleModal').remove()">×</span>
                  <h2>Edit Article</h2>
                  <div class="edit-form">
                    <div class="form-group">
                      <label for="editArticleTitle">Title</label>
                      <input type="text" id="editArticleTitle" value="${
                        article.title
                      }" placeholder="Article Title" required />
                    </div>
                    <div class="form-group">
                      <label for="editArticleContent">Content</label>
                      <textarea id="editArticleContent" placeholder="Article Content" required>${
                        article.content
                      }</textarea>
                    </div>
                    <div class="form-group">
                      <label for="editArticleImageFile">Featured Image</label>
                      <input type="file" id="editArticleImageFile" accept="image/*" />
                      ${
                        article.imageUrl
                          ? `<p>Current Image: <a href="${article.imageUrl}" target="_blank">View</a></p>`
                          : ""
                      }
                    </div>
                    <div class="form-actions">
                      <button onclick="saveArticleEdit('${articleId}')"><i class="fas fa-save"></i> Save Changes</button>
                    </div>
                  </div>
                </div>
              </div>
            `;
            document.body.insertAdjacentHTML("beforeend", modalHTML);
            document.getElementById("editArticleModal").style.display = "flex";
          });
      }

      function saveArticleEdit(articleId) {
        const title = document.getElementById("editArticleTitle").value.trim();
        const content = document
          .getElementById("editArticleContent")
          .value.trim();
        const imageFile = document.getElementById("editArticleImageFile")
          .files[0];

        if (!title || !content) {
          showToast("Please fill in both title and content", "error");
          return;
        }

        const updateData = {
          title,
          content,
          lastUpdated: Date.now(),
        };

        if (imageFile) {
          const storageRef = storage.ref(
            `articles/${Date.now()}_${imageFile.name}`
          );
          storageRef
            .put(imageFile)
            .then((snapshot) => {
              snapshot.ref.getDownloadURL().then((downloadURL) => {
                updateData.imageUrl = downloadURL;
                firebase
                  .database()
                  .ref("articles/" + articleId)
                  .update(updateData)
                  .then(() => {
                    showToast("Article updated successfully!", "success");
                    document.getElementById("editArticleModal").remove();
                    loadArticles();
                  });
              });
            })
            .catch((error) => {
              console.error("Error uploading image:", error);
              showToast("Failed to upload image: " + error.message, "error");
            });
        } else {
          firebase
            .database()
            .ref("articles/" + articleId)
            .update(updateData)
            .then(() => {
              showToast("Article updated successfully!", "success");
              document.getElementById("editArticleModal").remove();
              loadArticles();
            })
            .catch((error) => {
              showToast("Failed to update article: " + error.message, "error");
            });
        }
      }

      function deleteArticle(articleId) {
        if (confirm("Are you sure you want to delete this article?")) {
          firebase
            .database()
            .ref("articles/" + articleId)
            .remove()
            .then(() => {
              showToast("Article deleted successfully", "success");
            })
            .catch((error) => {
              showToast("Failed to delete article: " + error.message, "error");
            });
        }
      }

      function viewArticle(articleId) {
        firebase
          .database()
          .ref("articles/" + articleId)
          .once("value")
          .then((snapshot) => {
            const article = snapshot.val();
            showArticleModal(article);
          });
      }

      function showArticleModal(article) {
        const date = new Date(article.timestamp);
        const formattedDate = date.toLocaleDateString();

        const modalHTML = `
          <div class="modal" id="articleModal">
            <div class="modal-content">
              <span class="close-btn" onclick="document.getElementById('articleModal').remove()">×</span>
              <h2>${article.title}</h2>
              <p class="article-meta">Published: ${formattedDate}</p>
              ${
                article.imageUrl
                  ? `<img src="${article.imageUrl}" class="modal-image" />`
                  : ""
              }
              <div class="article-content">
                ${article.content.replace(/\n/g, "<br>")}
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML("beforeend", modalHTML);
        document.getElementById("articleModal").style.display = "flex";
      }

      function showImageModal(imageUrl) {
        const modalHTML = `
          <div class="modal" id="imageModal">
            <div class="modal-content">
              <span class="close-btn" onclick="document.getElementById('imageModal').remove()">×</span>
              <img src="${imageUrl}" class="modal-image" />
              <div class="modal-actions">
                <a href="${imageUrl}" target="_blank" class="button"><i class="fas fa-external-link-alt"></i> Open Original</a>
                <button onclick="document.getElementById('imageModal').remove()"><i class="fas fa-times"></i> Close</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML("beforeend", modalHTML);
        document.getElementById("imageModal").style.display = "flex";
      }

      function loadEvents() {
        const eventsBody = document.getElementById("eventsBody");
        firebase
          .database()
          .ref("events")
          .on("value", (snapshot) => {
            eventsBody.innerHTML = "";
            if (snapshot.exists()) {
              snapshot.forEach((child) => {
                const event = child.val();
                const eventRow = document.createElement("tr");
                eventRow.innerHTML = `
                  <td>${event.title}</td>
                  <td>
                    ${
                      event.imageUrl
                        ? `<img src="${event.imageUrl}" class="image-preview" onclick="showImageModal('${event.imageUrl}')" />`
                        : "No Image"
                    }
                  </td>
                  <td>${event.description.substring(0, 100)}${
                  event.description.length > 100 ? "..." : ""
                }</td>
                  <td>${new Date(event.dateTime).toLocaleString()}</td>
                  <td>
                    <button onclick="editEvent('${
                      child.key
                    }')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="danger" onclick="deleteEvent('${
                      child.key
                    }')"><i class="fas fa-trash"></i></button>
                    <button onclick="viewEvent('${
                      child.key
                    }')"><i class="fas fa-eye"></i></button>
                  </td>
                `;
                eventsBody.appendChild(eventRow);
              });
            } else {
              eventsBody.innerHTML = `
                <tr><td colspan="5" style="text-align: center;">No event data available.</td></tr>
              `;
            }
          });
      }

      // ======================
      // IMPROVED EVENT FUNCTIONS
      // ======================
      function addEvent() {
        const user = firebase.auth().currentUser;
        if (!user || user.email !== "admin@ai-solutions.com") {
          showToast("Unauthorized. Please log in as admin.", "error");
          return;
        }

        const title = document.getElementById("eventTitle").value.trim();
        const description = document
          .getElementById("eventDescription")
          .value.trim();
        const dateTime = document.getElementById("eventDateTime").value;
        const imageFile = document.getElementById("eventImageFile").files[0];

        if (!title || !description || !dateTime) {
          showToast("All fields are required.", "error");
          return;
        }

        const submitBtn = document.querySelector(
          "#events button[onclick='addEvent()']"
        );
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Uploading...';

        if (imageFile) {
          uploadImage(imageFile, "events")
            .then((downloadURL) => {
              saveEvent(title, description, dateTime, downloadURL);
              showToast("Event created successfully with image!", "success");
            })
            .catch((error) => {
              console.error(
                "Image upload failed, saving without image:",
                error
              );
              saveEvent(title, description, dateTime, "");
              showToast(
                `Event created without image (${error.message})`,
                "warning"
              );
            })
            .finally(() => {
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i class="fas fa-save"></i> Add Event';
            });
        } else {
          saveEvent(title, description, dateTime, "");
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-save"></i> Add Event';
          showToast("Event created successfully (no image)", "success");
        }
      }

      function saveEvent(title, description, dateTime, imageUrl) {
        const newEventRef = firebase.database().ref("events").push();
        const eventData = {
          title,
          description,
          dateTime,
          imageUrl,
          timestamp: Date.now(),
          lastUpdated: Date.now(),
          createdBy: firebase.auth().currentUser.email,
        };

        newEventRef
          .set(eventData)
          .then(() => {
            document.getElementById("eventTitle").value = "";
            document.getElementById("eventDescription").value = "";
            document.getElementById("eventDateTime").value = "";
            document.getElementById("eventImageFile").value = "";
          })
          .catch((error) => {
            console.error("Error saving event:", error);
            showToast("Failed to save event: " + error.message, "error");
          });
      }

      function editEvent(eventId) {
        firebase
          .database()
          .ref("events/" + eventId)
          .once("value")
          .then((snapshot) => {
            const event = snapshot.val();
            const modalHTML = `
              <div class="modal" id="editEventModal">
                <div class="modal-content">
                  <span class="close-btn" onclick="document.getElementById('editEventModal').remove()">×</span>
                  <h2>Edit Event</h2>
                  <div class="edit-form">
                    <div class="form-group">
                      <label for="editEventTitle">Title</label>
                      <input type="text" id="editEventTitle" value="${
                        event.title
                      }" placeholder="Event Title" required />
                    </div>
                    <div class="form-group">
                      <label for="editEventDescription">Description</label>
                      <textarea id="editEventDescription" placeholder="Event Description" required>${
                        event.description
                      }</textarea>
                    </div>
                    <div class="form-group">
                      <label for="editEventDateTime">Date & Time</label>
                      <input type="datetime-local" id="editEventDateTime" value="${
                        event.dateTime
                      }" required />
                    </div>
                    <div class="form-group">
                      <label for="editEventImageFile">Event Image</label>
                      <input type="file" id="editEventImageFile" accept="image/*" />
                      ${
                        event.imageUrl
                          ? `<p>Current Image: <a href="${event.imageUrl}" target="_blank">View</a></p>`
                          : ""
                      }
                    </div>
                    <div class="form-actions">
                      <button onclick="saveEventEdit('${eventId}')"><i class="fas fa-save"></i> Save Changes</button>
                    </div>
                  </div>
                </div>
              </div>
            `;
            document.body.insertAdjacentHTML("beforeend", modalHTML);
            document.getElementById("editEventModal").style.display = "flex";
          });
      }

      function saveEventEdit(eventId) {
        const title = document.getElementById("editEventTitle").value.trim();
        const description = document
          .getElementById("editEventDescription")
          .value.trim();
        const dateTime = document.getElementById("editEventDateTime").value;
        const imageFile =
          document.getElementById("editEventImageFile").files[0];

        if (!title || !description || !dateTime) {
          showToast("Please fill in all required fields", "error");
          return;
        }

        const updateData = {
          title,
          description,
          dateTime,
          lastUpdated: Date.now(),
        };

        if (imageFile) {
          const storageRef = storage.ref(
            `events/${Date.now()}_${imageFile.name}`
          );
          storageRef
            .put(imageFile)
            .then((snapshot) => {
              snapshot.ref.getDownloadURL().then((downloadURL) => {
                updateData.imageUrl = downloadURL;
                firebase
                  .database()
                  .ref("events/" + eventId)
                  .update(updateData)
                  .then(() => {
                    showToast("Event updated successfully!", "success");
                    document.getElementById("editEventModal").remove();
                    loadEvents();
                  });
              });
            })
            .catch((error) => {
              console.error("Error uploading image:", error);
              showToast("Failed to upload image: " + error.message, "error");
            });
        } else {
          firebase
            .database()
            .ref("events/" + eventId)
            .update(updateData)
            .then(() => {
              showToast("Event updated successfully!", "success");
              document.getElementById("editEventModal").remove();
              loadEvents();
            })
            .catch((error) => {
              showToast("Failed to update event: " + error.message, "error");
            });
        }
      }

      function deleteEvent(eventId) {
        if (confirm("Are you sure you want to delete this event?")) {
          firebase
            .database()
            .ref("events/" + eventId)
            .remove()
            .then(() => {
              showToast("Event deleted successfully", "success");
            })
            .catch((error) => {
              showToast("Failed to delete event: " + error.message, "error");
            });
        }
      }

      function viewEvent(eventId) {
        firebase
          .database()
          .ref("events/" + eventId)
          .once("value")
          .then((snapshot) => {
            const event = snapshot.val();
            showEventModal(event);
          });
      }

      function showEventModal(event) {
        const modalHTML = `
          <div class="modal" id="eventModal">
            <div class="modal-content">
              <span class="close-btn" onclick="document.getElementById('eventModal').remove()">×</span>
              <h2>${event.title}</h2>
              ${
                event.imageUrl
                  ? `<img src="${event.imageUrl}" class="modal-image" />`
                  : ""
              }
              <div class="event-details">
                <p><strong>Date & Time:</strong> ${new Date(
                  event.dateTime
                ).toLocaleString()}</p>
                <div class="event-description">
                  <h3>Description:</h3>
                  <p>${event.description.replace(/\n/g, "<br>")}</p>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML("beforeend", modalHTML);
        document.getElementById("eventModal").style.display = "flex";
      }

      function loadFeedback() {
        const feedbackBody = document.getElementById("feedbackBody");
        feedbackBody.innerHTML =
          '<tr><td colspan="6">Loading feedback...</td></tr>';

        firebase
          .database()
          .ref("feedback")
          .on("value", (snapshot) => {
            feedbackBody.innerHTML = "";
            feedbackData = [];

            if (snapshot.exists()) {
              snapshot.forEach((child) => {
                const feedback = child.val();
                feedback.id = child.key;
                feedbackData.push(feedback);

                // Create star rating display
                let stars = "";
                for (let i = 1; i <= 5; i++) {
                  stars +=
                    i <= feedback.rating
                      ? '<i class="fas fa-star" style="color: gold;"></i>'
                      : '<i class="far fa-star" style="color: gold;"></i>';
                }

                // Status badge
                let statusBadge = "";
                if (feedback.status === "new") {
                  statusBadge = '<span class="badge new">New</span>';
                } else if (feedback.status === "responded") {
                  statusBadge =
                    '<span class="badge responded">Responded</span>';
                }

                const row = document.createElement("tr");
                row.innerHTML = `
                  <td>${feedback.user || "Anonymous"}</td>
                  <td>${stars}</td>
                  <td>${feedback.comments.substring(0, 50)}${
                  feedback.comments.length > 50 ? "..." : ""
                }</td>
                  <td>${
                    feedback.date ||
                    new Date(feedback.timestamp).toLocaleDateString()
                  }</td>
                  <td>${statusBadge}</td>
                  <td>
                      <button onclick="viewFeedback('${
                        child.key
                      }')"><i class="fas fa-eye"></i></button>
                      <button onclick="respondToFeedback('${
                        child.key
                      }')"><i class="fas fa-reply"></i></button>
                      <button class="danger" onclick="deleteFeedback('${
                        child.key
                      }')"><i class="fas fa-trash"></i></button>
                  </td>
                `;
                feedbackBody.appendChild(row);
              });

              // Update statistics
              updateFeedbackStats(snapshot);
              // Apply current filter
              filterFeedback(currentFeedbackFilter);
            } else {
              feedbackBody.innerHTML =
                '<tr><td colspan="6">No feedback data available.</td></tr>';
            }
          });
      }

      function filterFeedback(filterType = null) {
        const searchInput = document
          .getElementById("feedbackSearch")
          .value.toLowerCase();

        if (filterType) {
          currentFeedbackFilter = filterType;
          // Update active filter button
          document
            .querySelectorAll(".feedback-filters .filter-btn")
            .forEach((btn) => {
              btn.classList.remove("active");
            });
          document
            .querySelector(
              `.feedback-filters .filter-btn[data-filter="${filterType}"]`
            )
            .classList.add("active");
        }

        const rows = document.querySelectorAll("#feedbackBody tr");
        rows.forEach((row) => {
          const rowText = row.textContent.toLowerCase();
          const matchesSearch = searchInput
            ? rowText.includes(searchInput)
            : true;
          let matchesFilter = true;

          if (currentFeedbackFilter !== "all") {
            if (currentFeedbackFilter === "new") {
              matchesFilter = row.querySelector(".badge.new") !== null;
            } else if (currentFeedbackFilter === "responded") {
              matchesFilter = row.querySelector(".badge.responded") !== null;
            } else if (currentFeedbackFilter === "1-2") {
              const starCount = (rowText.match(/fa-star/g) || []).length;
              matchesFilter = starCount <= 2;
            } else if (["3", "4", "5"].includes(currentFeedbackFilter)) {
              const starCount = (rowText.match(/fa-star/g) || []).length;
              matchesFilter = starCount === parseInt(currentFeedbackFilter);
            }
          }

          row.style.display = matchesSearch && matchesFilter ? "" : "none";
        });
      }

      function updateFeedbackStats(snapshot) {
        let total = 0;
        let sumRatings = 0;
        let newCount = 0;
        const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;

        snapshot.forEach((child) => {
          const feedback = child.val();
          total++;
          sumRatings += feedback.rating;

          if (feedback.status === "new") newCount++;
          if (feedback.timestamp > thirtyDaysAgo) {
            newCount++;
          }
        });

        document.getElementById("totalFeedback").textContent = total;
        document.getElementById("newFeedback").textContent = newCount;

        const avgRating = total > 0 ? (sumRatings / total).toFixed(1) : 0;
        document.getElementById("avgRating").textContent = avgRating;

        // Update star display
        const starsContainer = document.querySelector(
          ".feedback-stats .rating-stars"
        );
        starsContainer.innerHTML = "";
        const fullStars = Math.floor(avgRating);
        const hasHalfStar = avgRating % 1 >= 0.5;

        for (let i = 1; i <= 5; i++) {
          const star = document.createElement("i");
          if (i <= fullStars) {
            star.className = "fas fa-star";
          } else if (i === fullStars + 1 && hasHalfStar) {
            star.className = "fas fa-star-half-alt";
          } else {
            star.className = "far fa-star";
          }
          starsContainer.appendChild(star);
        }
      }

      function viewFeedback(feedbackId) {
        firebase
          .database()
          .ref("feedback/" + feedbackId)
          .once("value")
          .then((snapshot) => {
            const feedback = snapshot.val();

            // Create star rating display
            let stars = "";
            for (let i = 1; i <= 5; i++) {
              stars +=
                i <= feedback.rating
                  ? '<i class="fas fa-star" style="color: gold;"></i>'
                  : '<i class="far fa-star" style="color: gold;"></i>';
            }

            const modalHTML = `
              <div class="modal" id="feedbackModal">
                <div class="modal-content">
                  <span class="close-btn" onclick="document.getElementById('feedbackModal').remove()">×</span>
                  <h2>Feedback Details</h2>
                  <div class="feedback-details">
                    <p><strong>User:</strong> ${
                      feedback.user || "Anonymous"
                    }</p>
                    <p><strong>Rating:</strong> ${stars}</p>
                    <p><strong>Date:</strong> ${
                      feedback.date ||
                      new Date(feedback.timestamp).toLocaleDateString()
                    }</p>
                    <div class="feedback-comments">
                      <h3>Comments:</h3>
                      <p>${feedback.comments.replace(/\n/g, "<br>")}</p>
                    </div>
                    ${
                      feedback.response
                        ? `<div class="feedback-response">
                            <h3>Your Response:</h3>
                            <p>${feedback.response}</p>
                            <p><small>Responded on: ${new Date(
                              feedback.respondedAt
                            ).toLocaleString()} by ${
                            feedback.respondedBy
                          }</small></p>
                          </div>`
                        : ""
                    }
                  </div>
                </div>
              </div>
            `;

            document.body.insertAdjacentHTML("beforeend", modalHTML);
            document.getElementById("feedbackModal").style.display = "flex";

            // Mark as viewed if it was new
            if (feedback.status === "new") {
              firebase
                .database()
                .ref("feedback/" + feedbackId)
                .update({
                  status: "viewed",
                });
            }
          });
      }

      function respondToFeedback(feedbackId) {
        firebase
          .database()
          .ref("feedback/" + feedbackId)
          .once("value")
          .then((snapshot) => {
            const feedback = snapshot.val();

            const responseModalHTML = `
              <div class="modal" id="responseModal">
                <div class="modal-content">
                  <span class="close-btn" onclick="document.getElementById('responseModal').remove()">×</span>
                  <h2>Respond to Feedback</h2>
                  <div class="response-form">
                    <div class="form-group">
                      <label for="responseMessage">Your Response</label>
                      <textarea id="responseMessage" placeholder="Type your response here..." required>${
                        feedback.response || ""
                      }</textarea>
                    </div>
                    <div class="form-group">
                      <label for="responseEmail">Send to Email</label>
                      <input type="email" id="responseEmail" value="${
                        feedback.email || ""
                      }" placeholder="Recipient's email">
                    </div>
                    <div class="form-actions">
                      <button onclick="sendResponse('${feedbackId}')"><i class="fas fa-paper-plane"></i> Send Response</button>
                      <button class="secondary" onclick="document.getElementById('responseModal').remove()">Cancel</button>
                    </div>
                  </div>
                </div>
              </div>
            `;

            document.body.insertAdjacentHTML("beforeend", responseModalHTML);
            document.getElementById("responseModal").style.display = "flex";
          });
      }

      function sendResponse(feedbackId) {
        const responseMessage = document
          .getElementById("responseMessage")
          .value.trim();
        const responseEmail = document
          .getElementById("responseEmail")
          .value.trim();

        if (!responseMessage) {
          showToast("Please enter a response message", "error");
          return;
        }

        // Save the response to Firebase
        const updates = {
          status: "responded",
          response: responseMessage,
          respondedAt: Date.now(),
          respondedBy: firebase.auth().currentUser.email,
        };

        if (responseEmail) {
          updates.responseEmail = responseEmail;
        }

        firebase
          .database()
          .ref("feedback/" + feedbackId)
          .update(updates)
          .then(() => {
            showToast("Response saved successfully", "success");
            document.getElementById("responseModal").remove();
            loadFeedback();
          })
          .catch((error) => {
            showToast("Failed to save response: " + error.message, "error");
          });
      }

      function deleteFeedback(feedbackId) {
        if (confirm("Are you sure you want to delete this feedback?")) {
          firebase
            .database()
            .ref("feedback/" + feedbackId)
            .remove()
            .then(() => {
              showToast("Feedback deleted successfully", "success");
            })
            .catch((error) => {
              showToast("Failed to delete feedback: " + error.message, "error");
            });
        }
      }

      // ======================
      // IMPROVED TOAST NOTIFICATIONS
      // ======================
      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = `
          <div class="toast-icon">
            ${type === "success" ? '<i class="fas fa-check-circle"></i>' : ""}
            ${
              type === "error"
                ? '<i class="fas fa-exclamation-circle"></i>'
                : ""
            }
            ${
              type === "warning"
                ? '<i class="fas fa-exclamation-triangle"></i>'
                : ""
            }
          </div>
          <div class="toast-message">${message}</div>
          <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
          </button>
        `;

        const container = document.getElementById("toastContainer");
        container.appendChild(toast);

        setTimeout(() => {
          toast.classList.add("fade-out");
          setTimeout(() => toast.remove(), 300);
        }, 5000);
      }

      function loadAnalytics() {
        const timePeriod = parseInt(
          document.getElementById("timePeriod").value
        );
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - timePeriod + 1);
        const startDateStr = formatDate(startDate);
        const endDateStr = formatDate(endDate);

        firebase
          .database()
          .ref("analytics/dailyStats")
          .orderByKey()
          .startAt(startDateStr)
          .endAt(endDateStr)
          .once("value", (snapshot) => {
            const dailyStats = snapshot.val() || {};
            const allDates = generateDateRange(startDate, endDate);
            const visitorsData = allDates.map(
              (date) => dailyStats[date]?.visitors || 0
            );
            const engagementData = allDates.map((date) => {
              const stat = dailyStats[date];
              return stat && stat.sessions
                ? (stat.pageViews / stat.sessions).toFixed(1)
                : 0;
            });

            let totalVisitors = 0;
            let totalPageViews = 0;
            let totalSessions = 0;
            let totalSessionTime = 0;
            let totalBounces = 0;
            const trafficSourcesSum = {};
            const popularContentSum = {};

            Object.values(dailyStats).forEach((stat) => {
              totalVisitors += stat.visitors || 0;
              totalPageViews += stat.pageViews || 0;
              totalSessions += stat.sessions || 0;
              totalSessionTime += stat.totalSessionTime || 0;
              totalBounces += stat.bounces || 0;

              if (stat.trafficSources) {
                for (const source in stat.trafficSources) {
                  trafficSourcesSum[source] =
                    (trafficSourcesSum[source] || 0) +
                    stat.trafficSources[source];
                }
              }

              if (stat.popularContent) {
                for (const page in stat.popularContent) {
                  popularContentSum[page] =
                    (popularContentSum[page] || 0) + stat.popularContent[page];
                }
              }
            });

            const avgSessionDuration = totalSessions
              ? (totalSessionTime / totalSessions).toFixed(0)
              : 0;
            const bounceRate = totalSessions
              ? ((totalBounces / totalSessions) * 100).toFixed(1)
              : 0;

            // Calculate previous period stats for comparison
            const prevStartDate = new Date(startDate);
            prevStartDate.setDate(prevStartDate.getDate() - timePeriod);
            const prevEndDate = new Date(startDate);
            prevEndDate.setDate(prevEndDate.getDate() - 1);
            const prevStartDateStr = formatDate(prevStartDate);
            const prevEndDateStr = formatDate(prevEndDate);

            firebase
              .database()
              .ref("analytics/dailyStats")
              .orderByKey()
              .startAt(prevStartDateStr)
              .endAt(prevEndDateStr)
              .once("value", (prevSnapshot) => {
                const prevDailyStats = prevSnapshot.val() || {};
                let prevTotalVisitors = 0;
                let prevTotalPageViews = 0;
                let prevTotalSessions = 0;
                let prevTotalSessionTime = 0;
                let prevTotalBounces = 0;

                Object.values(prevDailyStats).forEach((stat) => {
                  prevTotalVisitors += stat.visitors || 0;
                  prevTotalPageViews += stat.pageViews || 0;
                  prevTotalSessions += stat.sessions || 0;
                  prevTotalSessionTime += stat.totalSessionTime || 0;
                  prevTotalBounces += stat.bounces || 0;
                });

                const prevAvgSessionDuration = prevTotalSessions
                  ? (prevTotalSessionTime / prevTotalSessions).toFixed(0)
                  : 0;
                const prevBounceRate = prevTotalSessions
                  ? ((prevTotalBounces / prevTotalSessions) * 100).toFixed(1)
                  : 0;

                // Calculate percentage changes
                const visitorsChange = prevTotalVisitors
                  ? (
                      ((totalVisitors - prevTotalVisitors) /
                        prevTotalVisitors) *
                      100
                    ).toFixed(1)
                  : 0;
                const pageViewsChange = prevTotalPageViews
                  ? (
                      ((totalPageViews - prevTotalPageViews) /
                        prevTotalPageViews) *
                      100
                    ).toFixed(1)
                  : 0;
                const sessionDurationChange = prevAvgSessionDuration
                  ? (
                      ((avgSessionDuration - prevAvgSessionDuration) /
                        prevAvgSessionDuration) *
                      100
                    ).toFixed(1)
                  : 0;
                const bounceRateChange = prevBounceRate
                  ? (
                      ((bounceRate - prevBounceRate) / prevBounceRate) *
                      100
                    ).toFixed(1)
                  : 0;

                // Update summary cards
                document.getElementById("totalVisitors").textContent =
                  totalVisitors;
                document.getElementById("totalPageViews").textContent =
                  totalPageViews;
                document.getElementById(
                  "avgSessionDuration"
                ).textContent = `${Math.floor(avgSessionDuration / 60)}m ${
                  avgSessionDuration % 60
                }s`;
                document.getElementById(
                  "bounceRate"
                ).textContent = `${bounceRate}%`;

                updateChangeIndicator("visitorsChange", visitorsChange);
                updateChangeIndicator("pageViewsChange", pageViewsChange);
                updateChangeIndicator(
                  "sessionDurationChange",
                  sessionDurationChange
                );
                updateChangeIndicator("bounceRateChange", bounceRateChange);

                // Render charts
                renderVisitorsChart(allDates, visitorsData);
                renderTrafficSourcesChart(trafficSourcesSum);
                renderContentChart(popularContentSum);
                renderEngagementChart(allDates, engagementData);
              });
          });
      }

      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function generateDateRange(start, end) {
        const dates = [];
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          dates.push(formatDate(new Date(d)));
        }
        return dates;
      }

      function updateChangeIndicator(elementId, changeValue) {
        const element = document.getElementById(elementId);
        const changeNum = parseFloat(changeValue);
        let changeText = changeValue;

        if (changeNum > 0) {
          changeText = `+${changeValue}%`;
          element.className = "summary-change positive";
        } else if (changeNum < 0) {
          changeText = `${changeValue}%`;
          element.className = "summary-change negative";
        } else {
          changeText = `${changeValue}%`;
          element.className = "summary-change";
        }

        element.textContent = changeText;
      }

      function renderVisitorsChart(dates, data) {
        const ctx = document.getElementById("visitorsChart").getContext("2d");
        if (window.visitorsChart) window.visitorsChart.destroy();

        // Format dates for display (e.g., "Jan 01")
        const formattedDates = dates.map((date) => {
          const [year, month, day] = date.split("-");
          const monthNames = [
            "Jan",
            "Feb",
            "Mar",
            "Apr",
            "May",
            "Jun",
            "Jul",
            "Aug",
            "Sep",
            "Oct",
            "Nov",
            "Dec",
          ];
          return `${monthNames[parseInt(month) - 1]} ${day}`;
        });

        window.visitorsChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: formattedDates,
            datasets: [
              {
                label: "Daily Visitors",
                data: data,
                borderColor: "rgb(75, 192, 192)",
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                tension: 0.3,
                fill: true,
                borderWidth: 2,
                pointBackgroundColor: "rgb(75, 192, 192)",
                pointRadius: 3,
                pointHoverRadius: 5,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0,
                },
              },
            },
          },
        });
      }

      function renderTrafficSourcesChart(data) {
        const ctx = document
          .getElementById("trafficSourcesChart")
          .getContext("2d");
        if (window.trafficSourcesChart) window.trafficSourcesChart.destroy();

        const labels =
          Object.keys(data).length > 0 ? Object.keys(data) : ["No Data"];
        const values = Object.keys(data).length > 0 ? Object.values(data) : [1];

        window.trafficSourcesChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: values,
                backgroundColor: [
                  "rgba(255, 99, 132, 0.7)",
                  "rgba(54, 162, 235, 0.7)",
                  "rgba(255, 206, 86, 0.7)",
                  "rgba(75, 192, 192, 0.7)",
                  "rgba(153, 102, 255, 0.7)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
              },
            },
          },
        });
      }

      function renderContentChart(data) {
        const ctx = document.getElementById("contentChart").getContext("2d");
        if (window.contentChart) window.contentChart.destroy();

        let sortedPages = [];
        if (Object.keys(data).length > 0) {
          sortedPages = Object.entries(data)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        } else {
          sortedPages = [["No Data", 1]];
        }

        const labels = sortedPages.map((entry) => {
          // Shorten long page titles for display
          const page = entry[0];
          if (page.length > 30) {
            return page.substring(0, 27) + "...";
          }
          return page;
        });
        const values = sortedPages.map((entry) => entry[1]);

        window.contentChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Page Views",
                data: values,
                backgroundColor: "rgba(54, 162, 235, 0.7)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              x: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      function renderEngagementChart(dates, data) {
        const ctx = document.getElementById("engagementChart").getContext("2d");
        if (window.engagementChart) window.engagementChart.destroy();

        // Format dates for display (e.g., "Jan 01")
        const formattedDates = dates.map((date) => {
          const [year, month, day] = date.split("-");
          const monthNames = [
            "Jan",
            "Feb",
            "Mar",
            "Apr",
            "May",
            "Jun",
            "Jul",
            "Aug",
            "Sep",
            "Oct",
            "Nov",
            "Dec",
          ];
          return `${monthNames[parseInt(month) - 1]} ${day}`;
        });

        window.engagementChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: formattedDates,
            datasets: [
              {
                label: "Avg. Pages per Session",
                data: data,
                borderColor: "rgb(153, 102, 255)",
                backgroundColor: "rgba(153, 102, 255, 0.2)",
                tension: 0.3,
                fill: true,
                borderWidth: 2,
                pointBackgroundColor: "rgb(153, 102, 255)",
                pointRadius: 3,
                pointHoverRadius: 5,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        setupTabSwitching();
        loadInquiries();
        loadAnalytics();

        // Initialize empty charts
        renderVisitorsChart([], []);
        renderTrafficSourcesChart({});
        renderContentChart({});
        renderEngagementChart([], []);
      });
    </script>

    <footer>
      <p>&copy; 2025 AI Solutions | All rights reserved</p>
    </footer>
  </body>
</html>
